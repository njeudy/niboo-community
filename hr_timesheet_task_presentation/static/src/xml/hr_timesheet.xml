<?xml version="1.0" encoding="utf-8"?>
<templates>
    <t t-extend="hr_timesheet_sheet.WeeklyTimesheet">

        <!-- Replace all line created with the foreach to take account of task -->
        <t t-jquery="div" t-operation="replace">
            <div class="oe_timesheet_weekly">
                <table class="table table-condensed table-responsive">
                    <tr>
                        <th class="oe_timesheet_first_col" colspan="1">
                            <t t-esc="moment(date).format('MMMM')"/>
                        </th>
                        <th class="oe_timesheet_first_col" colspan="1"/>
                        <t t-foreach="widget.dates" t-as="date">
                            <th t-att-class="'oe_timesheet_weekly_date_head' + (moment().format('DD-MM-YYYY') === moment(date).format('DD-MM-YYYY') ? ' oe_timesheet_weekly_today' : '')">
                                <t t-esc="moment(date).format('ddd')"/><br/>
                                <t t-esc="moment(date).format('DD')"/>
                            </th>
                        </t>
                        <th class="oe_timesheet_weekly_date_head">Total</th>
                    </tr>
                    <t t-set="prev" t-value=""/>
                    <tr t-foreach="widget.accounts" t-as="account">
                        <tr t-if="prev!=account.account">
                            <t t-set="prev" t-value="account.account"/>
                            <td class="oe_timesheet_weekly_account" colspan="2" style="background:rgba(226, 226, 224, 0.6);text-align:right;">
                                <img style="height:30px;" t-attf-src="/web/image?model=res.partner&amp;field=image_small&amp;id=#{account.partner_id}"/>
                                <a href="javascript:void(0)" t-att-data-id="JSON.stringify(account.account)" style="color:#a24689;">
                                    <t t-esc="widget.account_names[account.account]"/>
                                </a>
                            </td>
                        </tr>
                        <td style="text-align: left;" class="oe_timesheet_weekly_account_task" colspan="2"><p><a href="javascript:void(0)" t-att-data-id="JSON.stringify(account.task)">
                            <t t-esc="widget.task_names[account.task]"/></a></p></td>
                        <t t-set="day_count" t-value="0"/>
                        <t t-foreach="account.days" t-as="day">
                            <td style="padding:0;height:0px;text-align:center;" t-att-class="moment().format('DD-MM-YYYY') === moment(day.day).format('DD-MM-YYYY') ? 'oe_timesheet_weekly_today' : ''">
                                <div t-att-class="moment(day.day).weekday() > 5 or moment(day.day).weekday() == 0 ? 'oe_timesheet_weekend' : ''">
                                    <input t-if="!widget.get('effective_readonly')" class="oe_timesheet_weekly_input" t-att-data-account-task="account.account_task"
                                           t-att-data-day-count="day_count" type="text"/>
                                    <t t-if="!(!widget.get('effective_readonly') || day.lines.length == 1)">
                                        <span  t-att-data-account-task="account.account_task"
                                               t-att-data-day-count="day_count" class="oe_timesheet_weekly_box"/>
                                    </t>
                                    <t t-if="(!widget.get('effective_readonly') || day.lines.length == 1)">
                                        <span  t-att-data-account-task="account.account_task"
                                               t-att-data-day-count="day_count" style="color:rgba(0,0,0,1);" class="oe_timesheet_weekly_box"/>
                                    </t>
                                    <t t-set="day_count" t-value="day_count + 1"/>
                                </div>
                            </td>
                        </t>
                        <td t-att-data-account-task-total="account.account_task" class="oe_timesheet_total"/>
                    </tr>
                    <tr>
                        <td class="o_add_timesheet_line">
                            <div>
                                <button t-if="!widget.get('effective_readonly')" class="btn btn-sm btn-primary oe_edit_only oe_timesheet_button_add">Add a Line</button>
                            </div>
                        </td>
                        <td class="oe_timesheet_total">
                            Total
                        </td>
                        <t t-set="day_count" t-value="0"/>
                        <t t-foreach="widget.dates" t-as="date">
                            <td class="oe_timesheet_total">
                                <span class="oe_timesheet_weekly_box" t-att-data-day-total="day_count"/>
                                <t t-set="day_count" t-value="day_count + 1"/>
                            </td>
                        </t>
                        <td class="oe_timesheet_weekly_supertotal oe_timesheet_total"/>
                    </tr>
                </table>
                <div t-if="widget.accounts.length == 0">
                    <div class="oe_view_nocontent oe_edit_only">
                        <p class="oe_view_nocontent_create">Click to add projects, contracts or analytic accounts.</p>
                        <p>You will be able to register your working hours and activities.</p>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
            $(document).ready(function () {
                $('.oe_timesheet_weekly_account').on('click', function () {
                    var test = $(this).parent().next();
                    while (test.find(">:first-child").hasClass("oe_timesheet_weekly_account_task")) {
                        test.css('display', test.css('display') == "none" ? '' : 'none');
                        test = test.next();
                    }
                });
            });
            </script>
        </t>
    </t>
</templates>
